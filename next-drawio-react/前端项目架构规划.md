# Next-DrawIO Pro 前端项目架构规划

## 1. 项目概览

### 1.1 技术栈选择
- **框架**: Next.js 16 (App Router) + React 19
- **状态管理**: Zustand
- **画布引擎**: Fabric.js
- **UI 框架**: Tailwind CSS + Radix UI
- **开发语言**: TypeScript
- **构建工具**: Next.js 内置的 Turbopack
- **代码质量**: ESLint + Prettier + Husky

### 1.2 架构原则
- **模块化**: 功能模块独立，低耦合高内聚
- **类型安全**: 全面使用 TypeScript
- **性能优先**: 懒加载、代码分割、优化渲染
- **可测试性**: 组件和逻辑分离，便于单元测试
- **可扩展性**: 插件化架构，支持功能扩展

## 2. 项目目录结构

```
next-drawio/
├── src/                          # 源代码目录
│   ├── app/                      # Next.js App Router
│   │   ├── (dashboard)/          # 路由组：主应用界面
│   │   │   ├── layout.tsx        # 主应用布局
│   │   │   └── page.tsx          # 主应用页面
│   │   ├── (auth)/              # 路由组：认证相关
│   │   │   ├── login/
│   │   │   └── register/
│   │   ├── api/                 # API 路由
│   │   │   ├── files/          # 文件操作 API
│   │   │   ├── projects/       # 项目管理 API
│   │   │   └── export/         # 导出功能 API
│   │   ├── globals.css          # 全局样式
│   │   ├── layout.tsx          # 根布局
│   │   ├── page.tsx            # 首页
│   │   └── loading.tsx         # 全局加载组件
│   │
│   ├── components/              # React 组件
│   │   ├── ui/                 # 基础 UI 组件 (可复用)
│   │   │   ├── button/
│   │   │   │   ├── Button.tsx
│   │   │   │   ├── Button.stories.tsx
│   │   │   │   ├── Button.test.tsx
│   │   │   │   └── index.ts
│   │   │   ├── input/
│   │   │   ├── modal/
│   │   │   ├── tooltip/
│   │   │   ├── dropdown/
│   │   │   └── index.ts         # 导出文件
│   │   │
│   │   ├── layout/             # 布局组件
│   │   │   ├── Header/
│   │   │   │   ├── Header.tsx
│   │   │   │   ├── Header.module.css
│   │   │   │   └── index.ts
│   │   │   ├── Sidebar/
│   │   │   ├── StatusBar/
│   │   │   └── WorkspaceLayout/
│   │   │
│   │   ├── canvas/             # 画布相关组件
│   │   │   ├── CanvasContainer/
│   │   │   │   ├── CanvasContainer.tsx
│   │   │   │   ├── CanvasContainer.module.css
│   │   │   │   └── index.ts
│   │   │   ├── Rulers/
│   │   │   ├── Grid/
│   │   │   ├── Viewport/
│   │   │   └── ZoomControls/
│   │   │
│   │   ├── toolbar/            # 工具栏组件
│   │   │   ├── MainToolbar/
│   │   │   │   ├── MainToolbar.tsx
│   │   │   │   ├── ToolButton.tsx
│   │   │   │   └── index.ts
│   │   │   ├── PropertyToolbar/
│   │   │   └── ToolOptions/
│   │   │
│   │   ├── panels/             # 面板组件
│   │   │   ├── PropertiesPanel/
│   │   │   │   ├── PropertiesPanel.tsx
│   │   │   │   ├── sections/
│   │   │   │   │   ├── TransformSection.tsx
│   │   │   │   │   ├── AppearanceSection.tsx
│   │   │   │   │   └── StyleSection.tsx
│   │   │   │   └── index.ts
│   │   │   ├── LayersPanel/
│   │   │   │   ├── LayersPanel.tsx
│   │   │   │   ├── LayerItem.tsx
│   │   │   │   └── index.ts
│   │   │   ├── AssetsPanel/
│   │   │   └── HistoryPanel/
│   │   │
│   │   ├── tools/              # 工具组件
│   │   │   ├── SelectTool/
│   │   │   ├── RectangleTool/
│   │   │   ├── CircleTool/
│   │   │   ├── PenTool/
│   │   │   ├── TextTool/
│   │   │   └── index.ts
│   │   │
│   │   ├── modals/             # 模态框组件
│   │   │   ├── NewProjectModal/
│   │   │   ├── ExportModal/
│   │   │   ├── SettingsModal/
│   │   │   └── AboutModal/
│   │   │
│   │   └── features/           # 功能组件 (按业务领域)
│   │       ├── file-manager/
│   │       │   ├── FileList.tsx
│   │       │   ├── FileItem.tsx
│   │       │   └── FileOperations.tsx
│   │       ├── color-picker/
│   │       ├── gradient-editor/
│   │       └── text-editor/
│   │
│   ├── store/                  # 状态管理 (Zustand)
│   │   ├── index.ts           # Store 入口
│   │   ├── slices/            # 功能切片
│   │   │   ├── canvasStore.ts
│   │   │   ├── toolStore.ts
│   │   │   ├── layerStore.ts
│   │   │   ├── historyStore.ts
│   │   │   ├── uiStore.ts
│   │   │   └── fileStore.ts
│   │   ├── middleware/        # 中间件
│   │   │   ├── persist.ts
│   │   │   ├── history.ts
│   │   │   └── logger.ts
│   │   └── types/            # Store 类型定义
│   │       ├── canvas.types.ts
│   │       ├── tool.types.ts
│   │       └── common.types.ts
│   │
│   ├── hooks/                  # 自定义 React Hooks
│   │   ├── useCanvas.ts       # Canvas 操作
│   │   ├── useHistory.ts      # 历史记录
│   │   ├── useKeyboard.ts     # 键盘快捷键
│   │   ├── useSelection.ts    # 选择管理
│   │   ├── useViewport.ts     # 视口操作
│   │   ├── useFileManager.ts  # 文件管理
│   │   ├── useLocalStorage.ts # 本地存储
│   │   ├── useDebounce.ts     # 防抖
│   │   └── useHotkeys.ts      # 快捷键
│   │
│   ├── services/               # 业务服务层
│   │   ├── canvasService.ts   # Canvas 核心服务
│   │   ├── toolService.ts     # 工具管理服务
│   │   ├── fileService.ts     # 文件操作服务
│   │   ├── exportService.ts   # 导出服务
│   │   ├── storageService.ts  # 存储服务
│   │   ├── apiService.ts      # API 服务
│   │   └── keyboardService.ts # 键盘服务
│   │
│   ├── utils/                  # 工具函数库
│   │   ├── canvas/            # Canvas 相关工具
│   │   │   ├── geometry.ts    # 几何计算
│   │   │   ├── transform.ts   # 变换计算
│   │   │   ├── bounds.ts      # 边界计算
│   │   │   └── intersection.ts # 相交检测
│   │   ├── file/              # 文件处理工具
│   │   │   ├── svg.ts        # SVG 处理
│   │   │   ├── png.ts        # PNG 处理
│   │   │   ├── pdf.ts        # PDF 处理
│   │   │   └── json.ts       # JSON 处理
│   │   ├── color/             # 颜色工具
│   │   │   ├── conversion.ts  # 颜色转换
│   │   │   ├── palette.ts     # 调色板
│   │   │   └── gradient.ts    # 渐变处理
│   │   ├── math/              # 数学工具
│   │   │   ├── vector.ts      # 向量运算
│   │   │   ├── matrix.ts      # 矩阵运算
│   │   │   └── bezier.ts      # 贝塞尔曲线
│   │   ├── performance.ts     # 性能监控
│   │   ├── constants.ts       # 常量定义
│   │   ├── helpers.ts         # 通用辅助函数
│   │   └── validation.ts      # 数据验证
│   │
│   ├── types/                  # TypeScript 类型定义
│   │   ├── canvas.ts          # Canvas 类型
│   │   ├── tool.ts            # 工具类型
│   │   ├── layer.ts           # 图层类型
│   │   ├── object.ts          # 图形对象类型
│   │   ├── style.ts           # 样式类型
│   │   ├── file.ts            # 文件类型
│   │   ├── api.ts             # API 类型
│   │   ├── ui.ts              # UI 组件类型
│   │   └── index.ts           # 类型导出
│   │
│   ├── styles/                 # 样式文件
│   │   ├── globals.css         # 全局样式
│   │   ├── variables.css       # CSS 变量
│   │   ├── themes/             # 主题样式
│   │   │   ├── light.css
│   │   │   └── dark.css
│   │   ├── components/         # 组件样式
│   │   └── utilities/          # 工具样式
│   │
│   ├── constants/              # 常量定义
│   │   ├── tools.ts           # 工具常量
│   │   ├── shortcuts.ts       # 快捷键常量
│   │   ├── canvas.ts          # Canvas 常量
│   │   ├── file.ts            # 文件常量
│   │   └── config.ts          # 配置常量
│   │
│   └── assets/                 # 静态资源
│       ├── icons/             # 图标
│       │   ├── tools/         # 工具图标
│       │   ├── ui/            # UI 图标
│       │   └── index.ts       # 图标导出
│       ├── images/            # 图片资源
│       ├── fonts/             # 字体文件
│       └── templates/         # 模板文件
│
├── public/                     # 公共静态资源
│   ├── icons/                 # 应用图标
│   ├── favicons/              # 网站图标
│   ├── locales/               # 国际化文件
│   └── static/                # 静态文件
│
├── docs/                       # 项目文档
│   ├── api/                   # API 文档
│   ├── components/            # 组件文档
│   ├── guides/                # 使用指南
│   └── architecture/          # 架构文档
│
├── tests/                      # 测试文件
│   ├── __mocks__/            # Mock 文件
│   ├── fixtures/             # 测试数据
│   ├── unit/                 # 单元测试
│   ├── integration/          # 集成测试
│   ├── e2e/                  # 端到端测试
│   └── setup.ts              # 测试配置
│
├── .vscode/                   # VS Code 配置
│   ├── settings.json         # 编辑器设置
│   ├── extensions.json       # 推荐扩展
│   └── launch.json           # 调试配置
│
├── scripts/                    # 构建脚本
│   ├── build.js              # 构建脚本
│   ├── dev.js                # 开发脚本
│   └── deploy.js             # 部署脚本
│
├── config/                     # 配置文件
│   ├── jest.config.js        # Jest 测试配置
│   ├── tailwind.config.js    # Tailwind 配置
│   ├── eslint.config.js      # ESLint 配置
│   └── prettier.config.js    # Prettier 配置
│
├── package.json               # 项目依赖
├── tsconfig.json             # TypeScript 配置
├── next.config.ts            # Next.js 配置
├── tailwind.config.ts        # Tailwind 配置
├── .gitignore               # Git 忽略文件
├── .env.local               # 环境变量
└── README.md                # 项目说明
```

## 3. 组件架构设计

### 3.1 组件分层架构

```
┌─────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)            │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │     Pages       │  │     Layouts     │              │
│  │   (app/...)     │  │ (components/)   │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│                    功能层 (Feature Layer)                │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │   Components    │  │     Hooks       │              │
│  │ (components/)   │  │   (hooks/)      │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│                    服务层 (Service Layer)                │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │    Services     │  │     Store       │              │
│  │ (services/)     │  │   (store/)      │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│                    基础层 (Utility Layer)                │
│  ┌─────────────────┐  ┌─────────────────┐              │
│  │     Utils       │  │      Types      │              │
│  │   (utils/)      │  │   (types/)      │              │
│  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────┘
```

### 3.2 组件设计原则

1. **单一职责原则**：每个组件只负责一个功能
2. **组合优于继承**：使用组件组合构建复杂界面
3. **Props 接口设计**：明确的输入输出接口
4. **状态管理分离**：组件状态与全局状态分离
5. **可测试性**：组件逻辑与 UI 分离

### 3.3 组件命名规范

- **组件文件**: PascalCase (如 `Button.tsx`)
- **样式文件**: kebab-case (如 `button.module.css`)
- **Hook 文件**: camelCase + use 前缀 (如 `useCanvas.ts`)
- **类型文件**: camelCase + .types (如 `canvas.types.ts`)
- **常量文件**: camelCase (如 `canvas.ts`)

## 4. 状态管理架构

### 4.1 Zustand Store 结构

```typescript
// src/store/index.ts
import { create } from 'zustand';
import { devtools, persist } from 'zustand/middleware';
import { immer } from 'zustand/middleware/immer';

// 导入各个切片
import { createCanvasSlice } from './slices/canvasStore';
import { createToolSlice } from './slices/toolStore';
import { createLayerSlice } from './slices/layerStore';
import { createHistorySlice } from './slices/historyStore';
import { createUISlice } from './slices/uiStore';

export type AppStore = ReturnType<typeof createStore>;

export const createStore = () => {
  return create<AppStore>()(
    devtools(
      persist(
        immer((...args) => ({
          // 合并所有切片
          ...createCanvasSlice(...args),
          ...createToolSlice(...args),
          ...createLayerSlice(...args),
          ...createHistorySlice(...args),
          ...createUISlice(...args),
        })),
        {
          name: 'vector-draw-storage',
          partialize: (state) => ({
            // 只持久化部分状态
            ui: state.ui,
            tool: state.tool,
          }),
        }
      )
    )
  );
};

export const useAppStore = createStore();
```

### 4.2 状态切片设计

#### Canvas Store (画布状态)
```typescript
// src/store/slices/canvasStore.ts
interface CanvasState {
  // 画布对象
  objects: CanvasObject[];
  selectedObjectIds: string[];
  
  // 视口状态
  viewport: {
    width: number;
    height: number;
    zoom: number;
    pan: { x: number; y: number };
  };
  
  // 画布设置
  settings: {
    showGrid: boolean;
    showRulers: boolean;
    gridSize: number;
    snapToGrid: boolean;
  };
  
  // Actions
  addObject: (object: CanvasObject) => void;
  removeObject: (id: string) => void;
  updateObject: (id: string, updates: Partial<CanvasObject>) => void;
  selectObjects: (ids: string[]) => void;
  setViewport: (viewport: Partial<Viewport>) => void;
  updateSettings: (settings: Partial<CanvasSettings>) => void;
}
```

#### Tool Store (工具状态)
```typescript
// src/store/slices/toolStore.ts
interface ToolState {
  activeToolId: string;
  toolSettings: Record<string, any>;
  
  // 工具状态
  isDrawing: boolean;
  currentPath: Point[];
  
  // Actions
  setActiveTool: (toolId: string) => void;
  updateToolSettings: (settings: any) => void;
  setDrawingState: (isDrawing: boolean) => void;
  updateCurrentPath: (points: Point[]) => void;
}
```

### 4.3 中间件设计

#### History Middleware (历史记录)
```typescript
// src/store/middleware/history.ts
export const historyMiddleware = (config: StateCreator<AppState>) => (
  set: SetState<AppState>,
  get: GetState<AppState>
) => {
  return config(
    (args) => {
      const previousState = get();
      set(args);
      
      const currentState = get();
      const history = get().history;
      
      // 记录历史操作
      if (shouldRecordHistory(previousState, currentState)) {
        history.recordState(currentState);
      }
    },
    get
  );
};
```

#### Performance Middleware (性能监控)
```typescript
// src/store/middleware/performance.ts
export const performanceMiddleware = (config: StateCreator<AppState>) => (
  set: SetState<AppState>,
  get: GetState<AppState>
) => {
  return config(
    (args) => {
      const start = performance.now();
      set(args);
      const end = performance.now();
      
      if (end - start > 16.67) { // 超过 60fps
        console.warn(`Store update took ${end - start}ms`);
      }
    },
    get
  );
};
```

## 5. 代码组织规范

### 5.1 导入导出规范

```typescript
// 统一的导出方式
export { Button } from './Button';
export { ButtonProps } from './Button.types';

// 类型导入使用 import type
import type { CanvasObject } from '@/types/canvas';
import { useState } from 'react';
```

### 5.2 文件命名规范

- **组件文件**: `ComponentName.tsx`
- **样式文件**: `ComponentName.module.css`
- **类型文件**: `componentName.types.ts`
- **测试文件**: `ComponentName.test.tsx`
- **Storybook**: `ComponentName.stories.tsx`

### 5.3 依赖管理规范

```typescript
// 依赖注入模式
export const CanvasContainer: React.FC<CanvasContainerProps> = ({
  canvasService,
  toolService,
  ...props
}) => {
  // 使用注入的服务
};
```

## 6. 性能优化策略

### 6.1 组件优化

```typescript
// 使用 React.memo 进行组件记忆化
export const LayerItem = React.memo<LayerItemProps>(({
  layer,
  isSelected,
  onSelect,
  onUpdate
}) => {
  return (
    <div className={cn('layer-item', { 'selected': isSelected })}>
      {/* 组件内容 */}
    </div>
  );
});

// 使用 useMemo 缓存计算结果
const visibleObjects = useMemo(() => {
  return objects.filter(obj => isInViewport(obj, viewport));
}, [objects, viewport]);
```

### 6.2 虚拟化

```typescript
// 大量对象的虚拟化渲染
export const VirtualizedObjectList: React.FC = () => {
  return (
    <FixedSizeList
      height={400}
      itemCount={objects.length}
      itemSize={30}
      itemData={objects}
    >
      {ObjectRow}
    </FixedSizeList>
  );
};
```

### 6.3 代码分割

```typescript
// 动态导入大型组件
const ExportModal = lazy(() => import('@/components/modals/ExportModal'));
const PropertiesPanel = lazy(() => import('@/components/panels/PropertiesPanel'));

// 使用 Suspense 包装
<Suspense fallback={<LoadingSpinner />}>
  <ExportModal isOpen={showExportModal} />
</Suspense>
```

---

这个架构规划为 Next-DrawIO Pro 提供了完整的前端项目结构，遵循现代 React 最佳实践，具有良好的可维护性、可扩展性和性能表现。